<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COVID-19 Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoMdQIHQwsx5H0/Hk/eTqK3Ff8z/o4F/YhY/gA8="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjGwZFYgHQfrCJf5o7tD9L1fKMgszQ="
     crossorigin=""></script>

    <style>
        /* Custom scrollbar for AI Assistant chatbox */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Dark mode base styles */
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white {
            background-color: #2d3748; /* Darker background for cards */
        }
        .dark .text-gray-900 {
            color: #e2e8f0;
        }
        .dark .text-gray-800 {
            color: #e2e8f0;
        }
        .dark .text-gray-700 {
            color: #cbd5e0;
        }
        .dark .text-gray-600 {
            color: #a0aec0;
        }
        .dark .text-gray-500 {
            color: #718096;
        }
        .dark .border-gray-200 {
            border-color: #4a5568;
        }
        .dark .border-gray-300 {
            border-color: #4a5568;
        }
        .dark .bg-gray-50 {
            background-color: #4a5568;
        }
        .dark .bg-gray-100 {
            background-color: #1a202c;
        }
        .dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
        }
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
        }
        .dark .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
        }
        /* Specific dark mode adjustments for colored boxes */
        .dark .bg-blue-50 { background-color: #1e3a8a; border-color: #3b82f6; } /* Darker blue */
        .dark .text-blue-800 { color: #93c5fd; }
        .dark .bg-red-50 { background-color: #7f1d1d; border-color: #ef4444; } /* Darker red */
        .dark .text-red-800 { color: #fca5a5; }
        .dark .bg-green-50 { background-color: #166534; border-color: #22c55e; } /* Darker green */
        .dark .text-green-800 { color: #86efac; }
        .dark .bg-purple-50 { background-color: #4c1d95; border-color: #a78bfa; } /* Darker purple */
        .dark .text-purple-800 { color: #c4b5fd; }
        .dark .bg-yellow-50 { background-color: #78350f; border-color: #f59e0b; } /* Darker yellow */
        .dark .text-yellow-700 { color: #fcd34d; }
        .dark .bg-orange-50 { background-color: #7c2d12; border-color: #f97316; } /* Darker orange */
        .dark .text-orange-700 { color: #fdba74; }
        .dark .bg-teal-50 { background-color: #0f766e; border-color: #2dd4bf; } /* Darker teal */
        .dark .text-teal-700 { color: #5eead4; }
        .dark .bg-gray-950 { background-color: #0a0d11; } /* Darker footer */
        .dark .bg-gray-700 { background-color: #374151; }
        .dark .bg-gray-600 { background-color: #4b5563; }
        .dark .bg-gray-800 { background-color: #1f2937; }
        .dark .bg-indigo-600 { background-color: #4f46e5; }
        .dark .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .dark .focus\:ring-indigo-500:focus { --tw-ring-color: #6366f1; }
        .dark .focus\:border-indigo-500:focus { border-color: #6366f1; }
    </style>
</head>
<body class="font-inter transition-colors duration-300">
    <div id="app" class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 flex flex-col">
        <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden flex-grow">
            <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 sm:p-8 text-center rounded-t-xl">
                <h1 class="text-3xl sm:text-4xl font-extrabold mb-2 tracking-tight">
                    COVID-19 Tracker: Global & Country Data
                </h1>
                <p class="text-blue-100 text-sm sm:text-base">
                    Powered by disease.sh API
                </p>
                <p id="last-updated" class="text-blue-200 text-xs mt-2">
                    Last Updated: Loading...
                </p>
                <button id="dark-mode-toggle"
                    class="mt-4 px-4 py-2 bg-white text-gray-800 rounded-full shadow-md hover:bg-gray-100 transition-colors duration-300">
                    Dark Mode 🌙
                </button>
            </header>

            <nav class="p-4 sm:p-6 bg-gray-50 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <label for="country-select" class="text-lg font-medium text-gray-700">
                        Select Country:
                    </label>
                    <div class="relative w-full sm:w-auto">
                        <select id="country-select"
                            class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm appearance-none cursor-pointer bg-white">
                            <option value="">Loading countries...</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>

                    <label for="compare-country-select" class="text-lg font-medium text-gray-700 sm:ml-8">
                        Compare With:
                    </label>
                    <div class="relative w-full sm:w-auto">
                        <select id="compare-country-select"
                            class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm appearance-none cursor-pointer bg-white">
                            <option value="">-- Select Country --</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
            </nav>

            <main class="p-4 sm:p-6 lg:p-8">
                <div id="loading-indicator" class="text-center py-10 hidden">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                    <p id="loading-text" class="text-gray-600 text-lg">Loading data...</p>
                </div>

                <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative text-center mb-8 hidden">
                    <strong class="font-bold">Error!</strong>
                    <span id="error-text" class="block sm:inline"></span>
                    <p class="text-sm mt-2">Please check your internet connection or try selecting another country.</p>
                </div>

                <section id="global-overview" class="bg-white p-6 rounded-lg shadow-md mb-8 hidden">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">
                        Global COVID-19 Statistics
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md flex flex-col items-center">
                            <p class="text-lg text-blue-800">Total Cases:</p>
                            <p id="global-cases" class="text-4xl font-extrabold text-gray-900"></p>
                        </div>
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-md flex flex-col items-center">
                            <p class="text-lg text-red-800">Total Deaths:</p>
                            <p id="global-deaths" class="text-4xl font-extrabold text-gray-900"></p>
                        </div>
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-md flex flex-col items-center">
                            <p class="text-lg text-green-800">Total Recovered:</p>
                            <p id="global-recovered" class="text-4xl font-extrabold text-gray-900"></p>
                        </div>
                        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-md flex flex-col items-center col-span-full sm:col-span-1 sm:col-start-2">
                            <p class="text-lg text-purple-800">Total Tests:</p>
                            <p id="global-tests" class="text-4xl font-extrabold text-gray-900"></p>
                        </div>
                    </div>
                </section>

                <div id="country-data-section" class="space-y-8 hidden">
                    <section class="bg-white p-6 rounded-lg shadow-md">
                        <h2 id="country-overview-title" class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center">
                            Loading Overview...
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-5 shadow-sm flex flex-col items-center">
                                <h3 class="text-lg font-semibold text-red-700 mb-2">Active Cases</h3>
                                <p id="country-active-cases" class="text-4xl font-extrabold text-gray-900"></p>
                                <span id="country-new-cases-today" class="text-red-600 text-sm mt-1"></span>
                            </div>
                            <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-5 shadow-sm flex flex-col items-center">
                                <h3 class="text-lg font-semibold text-green-700 mb-2">Total Vaccinations</h3>
                                <p id="country-total-vaccinated" class="text-4xl font-extrabold text-gray-900"></p>
                                <span class="text-green-600 text-sm mt-1">(Total doses administered)</span>
                            </div>
                            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-5 shadow-sm flex flex-col items-center">
                                <h3 class="text-lg font-semibold text-blue-700 mb-2">Total Recovered</h3>
                                <p id="country-recovered" class="text-4xl font-extrabold text-gray-900"></p>
                                <span id="country-new-recovered-today" class="text-blue-600 text-sm mt-1"></span>
                            </div>
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-5 shadow-sm flex flex-col items-center">
                                <h3 class="text-lg font-semibold text-yellow-700 mb-2">Critical Cases</h3>
                                <p id="country-critical" class="text-4xl font-extrabold text-gray-900"></p>
                            </div>
                            <div class="bg-gray-50 border-l-4 border-gray-500 rounded-lg p-5 shadow-sm flex flex-col items-center">
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Cases Per One Million</h3>
                                <p id="country-cases-per-million" class="text-4xl font-extrabold text-gray-900"></p>
                            </div>
                            <div class="bg-red-100 border-l-4 border-red-400 rounded-lg p-5 shadow-sm flex flex-col items-center">
                                <h3 class="text-lg font-semibold text-red-800 mb-2">Total Deaths</h3>
                                <p id="country-deaths" class="text-4xl font-extrabold text-gray-900"></p>
                                <span id="country-new-deaths-today" class="text-red-700 text-sm mt-1"></span>
                            </div>
                        </div>
                    </section>

                    <section id="comparison-chart-section" class="bg-white p-6 rounded-lg shadow-md hidden">
                        <h3 id="comparison-chart-title" class="text-2xl font-bold text-gray-800 mb-4 text-center">
                            Comparison: Loading...
                        </h3>
                        <p class="text-gray-600 text-center mb-4">
                            Historical Cases Comparison (Last 90 Days)
                        </p>
                        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                            <div class="h-64 sm:h-80 md:h-96"> <canvas id="comparisonChart"></canvas>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 text-center">
                            (Note: Vaccination and Recovered trends can also be compared by modifying the chart dataKey)
                        </p>
                    </section>

                    <section class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                            Basic Case Trend & Forecast (<span id="forecast-country-name"></span>)
                        </h3>
                        <p class="text-gray-600 text-center mb-4">
                            Historical Cases with a 14-day basic forecast (linear regression).
                        </p>
                        <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                            <div class="h-64 sm:h-80 md:h-96"> <canvas id="forecastChart"></canvas>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 text-center">
                            *This is a basic statistical forecast and should not be used for medical or critical decision-making. Real-world predictions are complex and require advanced epidemiological models.
                        </p>
                    </section>

                    <section class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                            Case & Vaccination Trends (<span id="trends-country-name"></span>)
                        </h3>
                        <p class="text-gray-600 text-center mb-4">
                            Visualizing the last 90 days of data.
                        </p>
                        <div class="flex flex-col space-y-8">
                            <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Historical Cases</h4>
                                <div class="h-64 sm:h-80 md:h-96"> <canvas id="historicalCasesChart"></canvas>
                                </div>
                                <p class="text-sm text-gray-500 mt-2 text-center">
                                    (Daily reported cases)
                                </p>
                            </div>
                            <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Historical Vaccinations</h4>
                                <div class="h-64 sm:h-80 md:h-96"> <canvas id="historicalVaccinationsChart"></canvas>
                                </div>
                                <p class="text-sm text-gray-500 mt-2 text-center">
                                    (Daily reported total vaccinations)
                                </p>
                            </div>
                            <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                                <h4 class="text-lg font-semibold text-gray-700 mb-2">Historical Recoveries</h4>
                                <div class="h-64 sm:h-80 md:h-96"> <canvas id="historicalRecoveriesChart"></canvas>
                                </div>
                                <p class="text-sm text-gray-500 mt-2 text-center">
                                    (Daily reported recoveries)
                                </p>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                            Emergency & Prevention
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-orange-50 border-l-4 border-orange-500 rounded-lg p-5 shadow-sm">
                                <h4 class="text-xl font-semibold text-orange-700 mb-3">Emergency Contacts (General)</h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">
                                    <li>For medical emergencies, call your local emergency number (e.g., 911 in US, 112 in EU, 108 in India).</li>
                                    <li>Consult official government health websites or national health services for specific COVID-19 helplines.</li>
                                    <li>Contact your primary healthcare provider for personalized advice.</li>
                                </ul>
                            </div>
                            <div class="bg-teal-50 border-l-4 border-teal-500 rounded-lg p-5 shadow-sm">
                                <h4 class="text-xl font-semibold text-teal-700 mb-3">Prevention Guidelines</h4>
                                <ul class="list-disc list-inside text-gray-700 space-y-1">
                                    <li>Wear masks in crowded places.</li>
                                    <li>Practice frequent hand washing.</li>
                                    <li>Maintain social distancing.</li>
                                    <li>Get vaccinated and boosted.</li>
                                    <li>Stay home if you feel unwell.</li>
                                </ul>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-4 text-center">
                            *Detailed local health resource data (e.g., specific available beds, oxygen supply, doctor consultations) are generally not publicly available via common APIs for most countries. Please refer to official local government health websites for the most accurate information.
                        </p>
                    </section>

                    <section class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                            COVID-19 & Vaccination Snapshot for <span id="snapshot-country-name"></span>
                        </h3>
                        <p id="snapshot-text" class="text-gray-700 text-lg mb-4 leading-relaxed">
                            Loading snapshot...
                        </p>
                        <div class="bg-gray-100 border border-gray-200 rounded-md p-6 text-center text-gray-500 mt-4">
                            <p>For more granular, localized data, please consult official government health portals of <span id="snapshot-country-name-2"></span>.</p>
                        </div>
                    </section>

                    <section class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                            Did You Know?
                        </h3>
                        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-5 text-center shadow-sm">
                            <p id="did-you-know-fact" class="text-lg font-medium text-blue-800 transition-opacity duration-1000 ease-in-out">
                                Loading facts...
                            </p>
                        </div>
                    </section>

                    <section class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4 text-center">COVID-19 AI Assistant</h4>
                        <div id="ai-messages" class="flex-1 overflow-y-auto p-2 border border-gray-300 rounded-md bg-white mb-4 custom-scrollbar h-[400px]">
                            <p class="text-gray-500 text-center mt-4">Ask me anything about COVID-19!</p>
                        </div>
                        <div class="flex">
                            <input type="text" id="ai-input" placeholder="Type your question..."
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="ai-send-button"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-md transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                                Send
                            </button>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <footer class="mt-8 py-6 bg-gray-800 text-white text-center rounded-b-xl shadow-inner">
            <div class="max-w-6xl mx-auto px-4">
                <p class="text-xl font-bold mb-4">Application Features</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div class="p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200">
                        <h4 class="font-semibold text-lg mb-1">📊 Animated Counters</h4>
                        <p class="text-gray-300">Visually engaging display of real-time statistics.</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200">
                        <h4 class="font-semibold text-lg mb-1">📈 Trend Charts (Chart.js)</h4>
                        <p class="text-gray-300">Interactive historical data visualization for cases, recoveries, and vaccinations.</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200">
                        <h4 class="font-semibold text-lg mb-1">🤖 AI Assistant (Gemini API)</h4>
                        <p class="text-gray-300">Chatbot providing answers to COVID-19 related questions.</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200">
                        <h4 class="font-semibold text-lg mb-1">🌍 Country Comparison</h4>
                        <p class="text-gray-300">Compare COVID-19 metrics and trends between two selected countries.</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200">
                        <h4 class="font-semibold text-lg mb-1">🔮 Basic Trend Forecasting</h4>
                        <p class="text-gray-300">Simple client-side predictions for future case trends.</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200">
                        <h4 class="font-semibold text-lg mb-1">💡 "Did You Know?" Facts</h4>
                        <p class="text-gray-300">Engaging carousel of COVID-19 related facts and tips.</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-md hover:bg-gray-600 transition-colors duration-200 col-span-full sm:col-span-1 sm:col-start-2">
                        <h4 class="font-semibold text-lg mb-1">🌓 Dark Mode</h4>
                        <p class="text-gray-300">User-friendly toggle for light and dark themes.</p>
                    </div>
                </div>
                <p class="mt-6 text-gray-400 text-xs">
                    All listed features are fully functional and interactive within the application.
                </p>
                <p class="mt-2 text-gray-400 text-xs">
                    &copy; <span id="current-year"></span> COVID-19 Tracker. All rights reserved.
                </p>
            </div>
        </footer>
    </div>

    <script>
        // --- Global State Variables ---
        let selectedCountry = 'India';
        let compareCountry = '';
        let countryData = null;
        let compareCountryData = null;
        let globalData = null;
        let countryList = [];
        let lastUpdated = new Date();
        let currentFactIndex = 0;
        let darkMode = false;
        let chartInstances = {}; // To store Chart.js instances for destruction/update

        // --- DOM Elements ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const lastUpdatedElem = document.getElementById('last-updated');
        const countrySelect = document.getElementById('country-select');
        const compareCountrySelect = document.getElementById('compare-country-select');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const globalOverviewSection = document.getElementById('global-overview');
        const countryDataSection = document.getElementById('country-data-section');
        const comparisonChartSection = document.getElementById('comparison-chart-section');
        const comparisonChartTitle = document.getElementById('comparison-chart-title');
        const forecastCountryName = document.getElementById('forecast-country-name');
        const trendsCountryName = document.getElementById('trends-country-name');
        const snapshotCountryName = document.getElementById('snapshot-country-name');
        const snapshotCountryName2 = document.getElementById('snapshot-country-name-2');
        const snapshotText = document.getElementById('snapshot-text');
        const didYouKnowFactElem = document.getElementById('did-you-know-fact');
        const aiMessagesDiv = document.getElementById('ai-messages');
        const aiInput = document.getElementById('ai-input');
        const aiSendButton = document.getElementById('ai-send-button');
        const currentYearSpan = document.getElementById('current-year');

        // --- Animated Counter Function (Vanilla JS) ---
        function animateCounter(elementId, targetValue, duration = 1000) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const startValue = parseFloat(element.textContent.replace(/,/g, '')) || 0;
            const numericTargetValue = typeof targetValue === 'number' && !isNaN(targetValue) ? targetValue : 0;

            if (numericTargetValue === startValue) {
                element.textContent = numericTargetValue.toLocaleString();
                return;
            }

            const start = performance.now();
            let animationFrameId;

            const animate = (currentTime) => {
                const elapsed = currentTime - start;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = 0.5 - Math.cos(progress * Math.PI) / 2;
                const currentValue = Math.floor(startValue + (numericTargetValue - startValue) * easedProgress);

                element.textContent = currentValue.toLocaleString();

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    element.textContent = numericTargetValue.toLocaleString();
                }
            };

            animationFrameId = requestAnimationFrame(animate);

            // Cleanup function (though not strictly necessary in a single-page script without component unmounts)
            // For robustness, you might want to store animationFrameId globally and cancel previous ones.
        }

        // --- API Calls (Vanilla JS) ---

        async function fetchGlobalData() {
            try {
                const response = await fetch('https://disease.sh/v3/covid-19/all');
                if (!response.ok) {
                    throw new Error(`Failed to fetch global data: ${response.statusText}`);
                }
                const data = await response.json();
                return {
                    totalCases: data.cases,
                    totalDeaths: data.deaths,
                    totalRecovered: data.recovered,
                    totalTests: data.tests || 0
                };
            } catch (error) {
                console.error("Error in fetchGlobalData:", error);
                throw error;
            }
        }

        function processHistoricalData(casesData, recoveredData, vaccineData) {
            const dates = new Set([
                ...Object.keys(casesData || {}),
                ...Object.keys(recoveredData || {}),
                ...Object.keys(vaccineData || {})
            ].sort((a, b) => new Date(a) - new Date(b)));

            const processedData = Array.from(dates).map(date => ({
                date: date,
                cases: casesData ? casesData[date] || 0 : 0,
                recovered: recoveredData ? recoveredData[date] || 0 : 0,
                vaccines: vaccineData ? vaccineData[date] || 0 : 0,
            }));
            return processedData;
        }

        async function fetchDataForCountry(countryName) {
            // *** UPDATED: Fetch data for the last 90 days ***
            const days = 90; 

            try {
                const countryResponse = await fetch(`https://disease.sh/v3/covid-19/countries/${countryName}?strict=true`);
                if (!countryResponse.ok) {
                    if (countryResponse.status === 404) {
                        throw new Error(`Country data not found for "${countryName}". Please check the country name.`);
                    }
                    throw new Error(`Failed to fetch data for ${countryName}: ${countryResponse.statusText}`);
                }
                const data = await countryResponse.json();

                const historicalResponse = await fetch(`https://disease.sh/v3/covid-19/historical/${countryName}?lastdays=${days}`); // Using 'days' variable
                let historicalTimelineData = null;
                if (historicalResponse.ok) {
                    const histData = await historicalResponse.json();
                    if (histData && histData.timeline) {
                        historicalTimelineData = histData.timeline;
                    }
                } else {
                    console.warn(`Failed to fetch historical data for ${countryName}: ${historicalResponse.statusText}.`);
                }

                const vaccineResponse = await fetch(`https://disease.sh/v3/covid-19/vaccine/coverage/countries/${countryName}?lastdays=${days}`); // Using 'days' variable
                let historicalVaccineData = null;
                let totalVaccinatedCount = 0;
                if (vaccineResponse.ok) {
                    const vacData = await vaccineResponse.json();
                    if (vacData && vacData.timeline) {
                        historicalVaccineData = vacData.timeline;
                        const vaccineDates = Object.keys(historicalVaccineData);
                        if (vaccineDates.length > 0) {
                            totalVaccinatedCount = historicalVaccineData[vaccineDates[vaccineDates.length - 1]];
                        }
                    }
                } else {
                    console.warn(`Failed to fetch vaccination data for ${countryName}: ${vaccineResponse.statusText}.`);
                }

                const historicalChartData = processHistoricalData(
                    historicalTimelineData?.cases,
                    historicalTimelineData?.recovered,
                    historicalVaccineData
                );

                return {
                    cases: data.cases,
                    deaths: data.deaths,
                    recovered: data.recovered,
                    activeCases: data.active,
                    newCasesToday: data.todayCases,
                    newDeathsToday: data.todayDeaths,
                    newRecoveredToday: data.todayRecovered,
                    totalVaccinated: totalVaccinatedCount,
                    critical: data.critical,
                    casesPerOneMillion: data.casesPerOneMillion,
                    population: data.population,
                    historicalChartData: historicalChartData,
                    countryInfo: data.countryInfo,
                };
            } catch (error) {
                console.error("Error in fetchDataForCountry:", error);
                throw error;
            }
        }

        async function fetchCountryList() {
            try {
                const response = await fetch('https://disease.sh/v3/covid-19/countries');
                if (!response.ok) {
                    throw new Error(`Failed to fetch country list: ${response.statusText}`);
                }
                const data = await response.json();
                return data.map(country => country.country).sort();
            } catch (error) {
                console.error("Error in fetchCountryList:", error);
                return [];
            }
        }

        // --- Chart.js Integration ---
        function createOrUpdateChart(canvasId, chartType, data, options) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            // Destroy existing chart instance if it exists
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }

            chartInstances[canvasId] = new Chart(ctx, {
                type: chartType,
                data: data,
                options: options
            });
        }

        function renderHistoricalChart(canvasId, chartData, dataKey, strokeColor, label, dataKey2 = null, strokeColor2 = null, label2 = null) {
            if (!chartData || chartData.length === 0) {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const parent = canvas.parentElement;
                    if (parent) {
                        parent.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No ${label} historical data available for charting.</p>`;
                    }
                }
                return;
            }

            const labels = chartData.map(d => {
                const date = new Date(d.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const datasets = [{
                label: label,
                data: chartData.map(d => d[dataKey]),
                borderColor: strokeColor,
                backgroundColor: strokeColor,
                fill: false,
                tension: 0.1,
                pointRadius: 0
            }];

            if (dataKey2 && strokeColor2 && label2) {
                datasets.push({
                    label: label2,
                    data: chartData.map(d => d[dataKey2]),
                    borderColor: strokeColor2,
                    backgroundColor: strokeColor2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                });
            }

            createOrUpdateChart(canvasId, 'line', {
                labels: labels,
                datasets: datasets
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: darkMode ? '#e2e8f0' : '#4a5568' // Adjust legend text color
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: darkMode ? '#4a5568' : '#e0e0e0' // Adjust grid line color
                        },
                        ticks: {
                            color: darkMode ? '#cbd5e0' : '#4a5568' // Adjust x-axis tick color
                        }
                    },
                    y: {
                        grid: {
                            color: darkMode ? '#4a5568' : '#e0e0e0' // Adjust grid line color
                        },
                        ticks: {
                            color: darkMode ? '#cbd5e0' : '#4a5568' // Adjust y-axis tick color
                        }
                    }
                }
            });
        }

        // Basic Linear Regression for Forecasting
        function forecastData(historicalData, daysToForecast = 7) {
            if (!historicalData || historicalData.length < 10) {
                return [];
            }

            let sumX = 0;
            let sumY = 0;
            let sumXY = 0;
            let sumX2 = 0;
            const n = historicalData.length;

            historicalData.forEach((d, i) => {
                sumX += i;
                sumY += d.cases;
                sumXY += (i * d.cases);
                sumX2 += (i * i);
            });

            const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const b = (sumY - m * sumX) / n;

            const lastDate = new Date(historicalData[n - 1].date);
            const forecasted = [];

            for (let i = 1; i <= daysToForecast; i++) {
                const nextDate = new Date(lastDate);
                nextDate.setDate(lastDate.getDate() + i);
                const forecastedCases = Math.max(0, Math.round(m * (n + i - 1) + b));
                forecasted.push({
                    date: nextDate.toISOString().split('T')[0],
                    cases: forecastedCases,
                    isForecast: true
                });
            }
            return forecasted;
        }

        function renderForecastChart(canvasId, historicalChartData, selectedCountry) {
            if (!historicalChartData || historicalChartData.length === 0) {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const parent = canvas.parentElement;
                    if (parent) {
                        parent.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No historical data available for forecasting for ${selectedCountry}.</p>`;
                    }
                }
                return;
            }

            const historicalCases = historicalChartData.map(d => ({ date: d.date, cases: d.cases }));
            const forecastedCases = forecastData(historicalCases, 14);
            const combinedData = [...historicalCases, ...forecastedCases];

            const labels = combinedData.map(d => {
                const date = new Date(d.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            createOrUpdateChart(canvasId, 'line', {
                labels: labels,
                datasets: [
                    {
                        label: 'Actual Cases',
                        data: historicalCases.map(d => d.cases),
                        borderColor: '#ef4444',
                        backgroundColor: '#ef4444',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        segment: {
                            borderColor: ctx => ctx.p0.parsed.x < historicalCases.length -1 ? '#ef4444' : 'transparent'
                        }
                    },
                    {
                        label: 'Forecast',
                        data: combinedData.map((d, i) => i >= historicalCases.length -1 ? d.cases : null), // Only show forecast from the last actual point
                        borderColor: '#8884d8',
                        backgroundColor: '#8884d8',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0
                    }
                ]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: darkMode ? '#e2e8f0' : '#4a5568'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: darkMode ? '#4a5568' : '#e0e0e0'
                        },
                        ticks: {
                            color: darkMode ? '#cbd5e0' : '#4a5568'
                        }
                    },
                    y: {
                        grid: {
                            color: darkMode ? '#4a5568' : '#e0e0e0'
                        },
                        ticks: {
                            color: darkMode ? '#cbd5e0' : '#4a5568'
                        }
                    }
                }
            });
        }


        // --- AI Assistant Logic ---
        let aiChatHistory = [];
        let isSendingAI = false;

        async function sendAIMessage() {
            const input = aiInput.value.trim();
            if (input === '' || isSendingAI) return;

            const userMessage = { role: 'user', text: input };
            aiChatHistory.push(userMessage);
            displayAIMessage(userMessage);
            aiInput.value = '';
            isSendingAI = true;
            aiSendButton.disabled = true;
            aiInput.disabled = true;
            displayAIMessage({ role: 'assistant', text: 'Typing...', isTyping: true });
            aiMessagesDiv.scrollTop = aiMessagesDiv.scrollHeight; // Scroll to bottom

            try {
                const payload = { contents: aiChatHistory.map(msg => ({ role: msg.role, parts: [{ text: msg.text }] })) };
                const apiKey = ""; // Canvas will provide it at runtime.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                // Remove "Typing..." message
                aiMessagesDiv.removeChild(aiMessagesDiv.lastChild);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const assistantText = result.candidates[0].content.parts[0].text;
                    const assistantMessage = { role: 'assistant', text: assistantText };
                    aiChatHistory.push(assistantMessage);
                    displayAIMessage(assistantMessage);
                } else {
                    const errorMessage = { role: 'assistant', text: 'Sorry, I could not get a response. Please try again.' };
                    aiChatHistory.push(errorMessage);
                    displayAIMessage(errorMessage);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                // Remove "Typing..." message
                if (aiMessagesDiv.lastChild && aiMessagesDiv.lastChild.textContent.includes('Typing...')) {
                    aiMessagesDiv.removeChild(aiMessagesDiv.lastChild);
                }
                const errorMessage = { role: 'assistant', text: 'Error: Could not connect to the AI assistant.' };
                aiChatHistory.push(errorMessage);
                displayAIMessage(errorMessage);
            } finally {
                isSendingAI = false;
                aiSendButton.disabled = false;
                aiInput.disabled = false;
                aiMessagesDiv.scrollTop = aiMessagesDiv.scrollHeight; // Scroll to bottom
            }
        }

        function displayAIMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-2 ${message.role === 'user' ? 'text-right' : 'text-left'}`;

            const span = document.createElement('span');
            span.className = `inline-block p-2 rounded-lg max-w-[80%] ${
                message.role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'
            } ${message.isTyping ? 'animate-pulse' : ''}`;
            span.textContent = message.text;

            messageDiv.appendChild(span);
            aiMessagesDiv.appendChild(messageDiv);
            aiMessagesDiv.scrollTop = aiMessagesDiv.scrollHeight; // Scroll to bottom
        }

        // --- Did You Know Facts ---
        const didYouKnowFacts = [
            "COVID-19 is caused by the SARS-CoV-2 virus, a new strain of coronavirus.",
            "Vaccines significantly reduce the risk of severe illness, hospitalization, and death from COVID-19.",
            "Handwashing for at least 20 seconds with soap and water is crucial for preventing the spread of germs.",
            "Maintaining physical distance helps reduce the transmission of respiratory droplets.",
            "Masks, especially well-fitting ones, are effective in preventing the spread of the virus.",
            "Symptoms can range from mild to severe and may appear 2-14 days after exposure.",
            "Early detection and isolation are key to controlling outbreaks.",
            "The pandemic accelerated the development of mRNA vaccine technology.",
            "Global collaboration was essential in sharing data and research during the pandemic.",
            "Ventilation plays a significant role in reducing indoor transmission risk."
        ];

        function updateDidYouKnowFact() {
            // Fix: Corrected typo from didYouKnownFacts to didYouKnowFacts
            didYouKnowFactElem.textContent = didYouKnowFacts[currentFactIndex];
            currentFactIndex = (currentFactIndex + 1) % didYouKnowFacts.length; // Corrected variable name here
        }

        // --- Dark Mode Toggle ---
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.documentElement.classList.toggle('dark', darkMode);
            darkModeToggle.textContent = darkMode ? 'Light Mode ☀️' : 'Dark Mode 🌙';
            // Re-render charts to apply dark mode colors to grid/ticks/labels
            updateCharts();
        }

        // --- Update UI Functions ---
        function showLoading(country) {
            loadingText.textContent = `Loading data for ${country}${compareCountry ? ` and ${compareCountry}` : ''}...`;
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            globalOverviewSection.classList.add('hidden');
            countryDataSection.classList.add('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            hideLoading();
            globalOverviewSection.classList.add('hidden');
            countryDataSection.classList.add('hidden');
        }

        function updateGlobalDataUI() {
            if (globalData) {
                globalOverviewSection.classList.remove('hidden');
                animateCounter('global-cases', globalData.totalCases);
                animateCounter('global-deaths', globalData.totalDeaths);
                animateCounter('global-recovered', globalData.totalRecovered);
                animateCounter('global-tests', globalData.totalTests);
            } else {
                globalOverviewSection.classList.add('hidden');
            }
        }

        function updateCountryDataUI() {
            if (countryData) {
                countryDataSection.classList.remove('hidden');
                document.getElementById('country-overview-title').innerHTML = `
                    ${countryData.countryInfo && countryData.countryInfo.flag ? `<img src="${countryData.countryInfo.flag}" alt="${selectedCountry} Flag" class="w-8 h-auto mr-3 shadow" />` : ''}
                    ${selectedCountry} Overview
                `;
                animateCounter('country-active-cases', countryData.activeCases);
                document.getElementById('country-new-cases-today').textContent = `(${countryData.newCasesToday > 0 ? `+${countryData.newCasesToday}` : countryData.newCasesToday} today)`;
                animateCounter('country-total-vaccinated', countryData.totalVaccinated);
                animateCounter('country-recovered', countryData.recovered);
                document.getElementById('country-new-recovered-today').textContent = `(${countryData.newRecoveredToday > 0 ? `+${countryData.newRecoveredToday}` : countryData.newRecoveredToday} today)`;
                animateCounter('country-critical', countryData.critical);
                animateCounter('country-cases-per-million', countryData.casesPerOneMillion);
                animateCounter('country-deaths', countryData.deaths);
                document.getElementById('country-new-deaths-today').textContent = `(${countryData.newDeathsToday > 0 ? `+${countryData.newDeathsToday}` : countryData.newDeathsToday} today)`;

                forecastCountryName.textContent = selectedCountry;
                trendsCountryName.textContent = selectedCountry;
                snapshotCountryName.textContent = selectedCountry;
                snapshotCountryName2.textContent = selectedCountry;

                snapshotText.innerHTML = `
                    As of ${lastUpdated.toLocaleDateString()}, ${selectedCountry} has reported a total of <span class="font-semibold text-red-600 dark:text-red-400">${countryData.cases?.toLocaleString()}</span> COVID-19 cases, with <span class="font-semibold text-blue-600 dark:text-blue-400">${countryData.recovered?.toLocaleString()}</span> recoveries, and <span class="font-semibold text-red-800 dark:text-red-300">${countryData.deaths?.toLocaleString()}</span> total deaths.
                    The active caseload stands at <span class="font-semibold text-orange-600 dark:text-orange-400">${countryData.activeCases?.toLocaleString()}</span>.
                    A significant effort in vaccination has led to <span class="font-semibold text-green-600 dark:text-green-400">${countryData.totalVaccinated?.toLocaleString()}</span> total vaccine doses administered.
                    These figures reflect the ongoing public health situation and the country's response to the pandemic.
                `;

                updateCharts(); // Render/update all charts
            } else {
                countryDataSection.classList.add('hidden');
            }
        }

        function updateCharts() {
            if (countryData && countryData.historicalChartData) {
                renderHistoricalChart('historicalCasesChart', countryData.historicalChartData, 'cases', '#ef4444', 'Cases');
                renderHistoricalChart('historicalVaccinationsChart', countryData.historicalChartData, 'vaccines', '#22c55e', 'Vaccinations');
                renderHistoricalChart('historicalRecoveriesChart', countryData.historicalChartData, 'recovered', '#3b82f6', 'Recoveries');
                renderForecastChart('forecastChart', countryData.historicalChartData, selectedCountry);
            }

            if (compareCountryData && countryData && countryData.historicalChartData && compareCountryData.historicalChartData) {
                comparisonChartSection.classList.remove('hidden');
                comparisonChartTitle.textContent = `Comparison: ${selectedCountry} vs. ${compareCountry}`;

                const combinedChartData = [];
                const allDates = new Set([
                    ...countryData.historicalChartData.map(d => d.date),
                    ...compareCountryData.historicalChartData.map(d => d.date)
                ].sort((a, b) => new Date(a) - new Date(b)));

                allDates.forEach(date => {
                    const mainCountryEntry = countryData.historicalChartData.find(d => d.date === date) || {};
                    const compareCountryEntry = compareCountryData.historicalChartData.find(d => d.date === date) || {};
                    combinedChartData.push({
                        date: date,
                        [`${selectedCountry} Cases`]: mainCountryEntry.cases || 0,
                        [`${compareCountry} Cases`]: compareCountryEntry.cases || 0
                    });
                });

                renderHistoricalChart(
                    'comparisonChart',
                    combinedChartData,
                    `${selectedCountry} Cases`, '#ef4444', `${selectedCountry} Cases`,
                    `${compareCountry} Cases`, '#3b82f6', `${compareCountry} Cases`
                );
            } else {
                comparisonChartSection.classList.add('hidden');
            }
        }

        // --- Main Data Fetching & UI Update Logic ---
        async function updateData() {
            showLoading(selectedCountry);
            try {
                // Fetch global data
                globalData = await fetchGlobalData();
                updateGlobalDataUI();

                // Fetch main country data
                countryData = await fetchDataForCountry(selectedCountry);

                // Fetch compare country data if selected
                if (compareCountry && compareCountry !== selectedCountry) {
                    compareCountryData = await fetchDataForCountry(compareCountry);
                } else {
                    compareCountryData = null;
                }

                lastUpdated = new Date();
                lastUpdatedElem.textContent = `Last Updated: ${lastUpdated.toLocaleString()}`;
                updateCountryDataUI();
                hideLoading();
            } catch (err) {
                console.error("Error in updateData:", err);
                showError(err.message || "Failed to load data. Please try again.");
            }
        }

        // --- Event Listeners ---
        darkModeToggle.addEventListener('click', toggleDarkMode);

        countrySelect.addEventListener('change', (event) => {
            selectedCountry = event.target.value;
            updateData();
        });

        compareCountrySelect.addEventListener('change', (event) => {
            compareCountry = event.target.value;
            updateData();
        });

        aiSendButton.addEventListener('click', sendAIMessage);
        aiInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !isSendingAI) {
                sendAIMessage();
            }
        });

        // --- Initial Load and Periodic Updates ---
        window.onload = async () => {
            currentYearSpan.textContent = new Date().getFullYear();

            // Populate country dropdowns
            countryList = await fetchCountryList();
            countrySelect.innerHTML = ''; // Clear loading option
            compareCountrySelect.innerHTML = '<option value="">-- Select Country --</option>'; // Clear loading option

            countryList.forEach(country => {
                const option1 = document.createElement('option');
                option1.value = country;
                option1.textContent = country;
                countrySelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = country;
                option2.textContent = country;
                compareCountrySelect.appendChild(option2);
            });

            // Set default selected country
            countrySelect.value = selectedCountry;

            // Initial data fetch
            await updateData();

            // Start periodic updates
            setInterval(updateData, 300000); // Refresh all data every 5 minutes
            setInterval(updateDidYouKnowFact, 10000); // Change fact every 10 seconds
        };
    </script>
</body>
</html>
